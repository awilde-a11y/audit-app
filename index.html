<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audit-App light (v4)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 1020px; margin: 0 auto; padding: 18px; }
    .card { background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 16px; }
    h1 { margin: 0; font-size: 20px; }
    .sub { margin: 6px 0 0; color: #555; font-size: 13px; }

    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom: 12px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #f1f2f7; border: 1px solid #e4e6f1; font-size: 12px; white-space: nowrap; }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin: 14px 0 10px; }
    .tabbtn { cursor:pointer; border-radius: 999px; border: 1px solid #d9dbe6; background:#fff; padding: 9px 12px; font: inherit; }
    .tabbtn.active { background:#111; color:#fff; border-color:#111; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, textarea, button { font: inherit; border-radius: 12px; border: 1px solid #d9dbe6; padding: 10px 12px; }
    input, select { background:#fff; }
    textarea { background:#fff; min-height: 42px; resize: vertical; width: 100%; }
    button { cursor:pointer; background:#111; color:#fff; border:1px solid #111; }
    button.secondary { background:#fff; color:#111; border: 1px solid #d9dbe6; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }

    .sectionTitle { margin: 14px 0 8px; font-weight: 750; }
    .muted { color:#666; font-size: 12px; }

    .auditCard { border: 1px solid #eef0f6; border-radius: 16px; padding: 12px; background:#fff; }
    .q { border-top: 1px solid #f0f1f7; padding-top: 10px; margin-top: 10px; }
    .q:first-child { border-top: none; padding-top: 0; margin-top: 0; }
    .qTitle { font-weight: 650; }
    .yn { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top: 6px; }
    .yn label { display:flex; gap:8px; align-items:center; cursor:pointer; }

    .reqBox { margin-top: 8px; padding: 10px; border-radius: 14px; border: 1px solid #ffd6d6; background: #fff6f6; display:none; }
    .reqBox.show { display:block; }
    .reqHint { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }

    .photoWrap { margin-top: 10px; padding: 10px; border-radius: 14px; border: 1px dashed #ffb6b6; background: #fff; }
    .photoRow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    .photoThumb { margin-top: 10px; max-width: 220px; width: 100%; border-radius: 12px; border: 1px solid #eef0f6; display:none; }
    .photoThumb.show { display:block; }
    .dangerText { color:#b00020; font-size: 12px; }

    .list { display:grid; gap:10px; margin-top: 10px; }
    .item { border: 1px solid #eef0f6; border-radius: 16px; padding: 12px; display:grid; gap:8px; }
    .itemTop { display:flex; justify-content: space-between; gap:10px; flex-wrap: wrap; }
    .badge { padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #e4e6f1; background:#f1f2f7; }
    .danger { border-color:#ffd6d6; background:#fff0f0; }
    .ok { border-color:#d9f5df; background:#f0fff3; }
    .small { font-size: 12px; color:#555; }
    .hr { height:1px; background:#eef0f6; border:0; margin: 12px 0; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; }
    .photoMini { max-width: 160px; width: 100%; border-radius: 12px; border: 1px solid #eef0f6; margin-top: 6px; }

    .readonlyBox { border: 1px solid #eef0f6; border-radius: 14px; padding: 10px; background: #fafbff; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1 id="appTitle">Audit-App light</h1>
          <div class="sub" id="appSub">Klicken, nachverfolgen, nachweisen ‚Äì ohne Chaos.</div>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <span class="pill" id="nowPill">‚Äî</span>
          <select id="lang">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
          <button class="secondary" id="pdfBtn">PDF-Nachweis</button>
          <button class="secondary" id="exportBtn">Export (JSON)</button>
          <button class="secondary" id="resetBtn">Reset</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tabbtn active" data-tab="audit" id="tabAudit">Audit</button>
        <button class="tabbtn" data-tab="actions" id="tabActions">Ma√ünahmen</button>
        <button class="tabbtn" data-tab="overview" id="tabOverview">√úbersicht</button>
        <button class="tabbtn" data-tab="archive" id="tabArchive">Archiv</button>
      </div>

      <!-- AUDIT -->
      <div id="view_audit">
        <div class="grid2">
          <div class="auditCard">
            <div class="itemTop">
              <div>
                <div class="qTitle" id="dailyTitle">ü¶∫ T√§glicher Sicherheits- & Staplercheck ‚Äì Wareneingang</div>
                <div class="muted" id="dailyHint">Dauer: 1‚Äì2 Minuten ‚Ä¢ Bei Abweichung: Ma√ünahme + Foto Pflicht.</div>
              </div>
              <span class="badge" id="dailyBadge">T√§glich</span>
            </div>

            <div class="hr"></div>

            <div class="grid2">
              <div>
                <label class="muted" id="roleLabelDaily">Rolle</label>
                <select id="roleDaily">
                  <option value="teamcaptain">Teamcaptain</option>
                  <option value="bereichsleiter">Bereichsleiter</option>
                </select>
              </div>
              <div>
                <label class="muted" id="nameLabelDaily">Name</label>
                <input id="nameDaily" placeholder="z. B. Ali" />
              </div>
            </div>

            <div class="sectionTitle" id="questionsDaily">Fragen</div>
            <div id="dailyQuestions"></div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between;">
              <span class="muted" id="autoSaveHint">Speichert automatisch im Browser.</span>
              <button id="submitDaily">Audit speichern</button>
            </div>
          </div>

          <div class="auditCard">
            <div class="itemTop">
              <div>
                <div class="qTitle" id="weeklyTitle">üîÑ W√∂chentlicher Prozessaudit ‚Äì Wareneingang</div>
                <div class="muted" id="weeklyHint">Dauer: 3‚Äì6 Minuten ‚Ä¢ Bei Abweichung: Ma√ünahme + Foto Pflicht.</div>
              </div>
              <span class="badge" id="weeklyBadge">W√∂chentlich</span>
            </div>

            <div class="hr"></div>

            <div class="grid2">
              <div>
                <label class="muted" id="roleLabelWeekly">Rolle</label>
                <select id="roleWeekly">
                  <option value="bereichsleiter">Bereichsleiter</option>
                  <option value="teamcaptain">Teamcaptain</option>
                </select>
              </div>
              <div>
                <label class="muted" id="nameLabelWeekly">Name</label>
                <input id="nameWeekly" placeholder="z. B. Alessandro" />
              </div>
            </div>

            <div class="sectionTitle" id="questionsWeekly">Fragen</div>
            <div id="weeklyQuestions"></div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between;">
              <span class="muted" id="autoSaveHint2">Speichert automatisch im Browser.</span>
              <button id="submitWeekly">Audit speichern</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div id="view_actions" style="display:none;">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div class="sectionTitle" id="actionsTitle">üõ†Ô∏è Ma√ünahmenverfolgung</div>
            <div class="muted" id="actionsHint">Abweichungen erzeugen automatisch Ma√ünahmen. Foto ist Pflicht bei Abweichung.</div>
          </div>

          <div class="row">
            <select id="actionsFilter">
              <option value="all" id="f_all">Alle</option>
              <option value="open" id="f_open">Offen</option>
              <option value="inprogress" id="f_inprogress">In Arbeit</option>
              <option value="done" id="f_done">Erledigt</option>
              <option value="overdue" id="f_overdue">√úberf√§llig</option>
            </select>
            <button class="secondary" id="clearDoneBtn">Erledigte l√∂schen</button>
          </div>
        </div>

        <div class="list" id="actionsList"></div>
      </div>

      <!-- OVERVIEW -->
      <div id="view_overview" style="display:none;">
        <div class="sectionTitle" id="ovTitle">üìä √úbersicht & Nachweis</div>
        <div class="muted" id="ovHint">Live-√úberblick: Audits, offene/√ºberf√§llige Ma√ünahmen, Wiederholer.</div>

        <div class="kpi" id="kpi"></div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div class="sectionTitle" id="ovAuditsTitle">Letzte Audits</div>
            <div class="list" id="auditsList"></div>
          </div>
          <div>
            <div class="sectionTitle" id="ovRepeatTitle">Wiederkehrende Abweichungen</div>
            <div class="muted" id="ovRepeatHint">Top 8 (letzte 60 Ma√ünahmen)</div>
            <div class="list" id="repeatList"></div>
          </div>
        </div>
      </div>

      <!-- ARCHIVE (read-only) -->
      <div id="view_archive" style="display:none;">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div class="sectionTitle" id="archTitle">üóÑÔ∏è Archiv (read-only)</div>
            <div class="muted" id="archHint">Automatisch: ‚ÄûErledigt‚Äú + 30 Tage ‚Üí Archiv. PDF enth√§lt trotzdem alles.</div>
          </div>

          <div class="row">
            <select id="archiveFilter">
              <option value="all" id="af_all">Alle</option>
              <option value="done" id="af_done">Erledigt</option>
            </select>
            <input id="archiveSearch" placeholder="Suche (z. B. Stapler, PSA ‚Ä¶)" />
          </div>
        </div>

        <div class="list" id="archiveList"></div>
      </div>

    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "audit-app-light.v4";
  const MAX_REPEAT_SAMPLE = 60;

  const now = () => new Date();
  const ts = () => Date.now();
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  function fmtDateTime(ms, lang) {
    const d = new Date(ms);
    const loc = lang === "en" ? "en-GB" : "de-DE";
    return d.toLocaleString(loc, { dateStyle: "medium", timeStyle: "short" });
  }

  function startOfToday() {
    const d = now();
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function load() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }

  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  let state = load();
  state.lang = state.lang || "de";
  state.audits = state.audits || [];
  state.actions = state.actions || [];
  state.archivedActions = state.archivedActions || [];
  state.drafts = state.drafts || { daily:{}, weekly:{} };

  // --- AUTO ARCHIVE (done + 30 days) ---
  function days(n) { return n * 24 * 60 * 60 * 1000; }

  function autoArchiveDoneActions() {
    const THIRTY_DAYS = days(30);
    const nowMs = Date.now();

    const keep = [];
    for (const a of state.actions) {
      const doneSince = a.doneAt || null;
      const shouldArchive = (a.status === "done") && doneSince && ((nowMs - doneSince) >= THIRTY_DAYS);

      if (shouldArchive) {
        if (!state.archivedActions.find(x => x.id === a.id)) state.archivedActions.unshift(a);
      } else {
        keep.push(a);
      }
    }
    state.actions = keep;
    save();
  }

  const I18N = {
    de: {
      appTitle: "Audit-App light",
      appSub: "Klicken, nachverfolgen, nachweisen ‚Äì ohne Chaos.",
      tabAudit: "Audit",
      tabActions: "Ma√ünahmen",
      tabOverview: "√úbersicht",
      tabArchive: "Archiv",
      dailyTitle: "ü¶∫ T√§glicher Sicherheits- & Staplercheck ‚Äì Wareneingang",
      dailyHint: "Dauer: 1‚Äì2 Minuten ‚Ä¢ Bei Abweichung: Ma√ünahme + Foto Pflicht.",
      weeklyTitle: "üîÑ W√∂chentlicher Prozessaudit ‚Äì Wareneingang",
      weeklyHint: "Dauer: 3‚Äì6 Minuten ‚Ä¢ Bei Abweichung: Ma√ünahme + Foto Pflicht.",
      roleLabel: "Rolle",
      nameLabel: "Name",
      questions: "Fragen",
      autoSave: "Speichert automatisch im Browser.",
      submit: "Audit speichern",
      actionsTitle: "üõ†Ô∏è Ma√ünahmenverfolgung",
      actionsHint: "Abweichungen erzeugen automatisch Ma√ünahmen. Foto ist Pflicht bei Abweichung.",
      archTitle: "üóÑÔ∏è Archiv (read-only)",
      archHint: "Automatisch: ‚ÄûErledigt‚Äú + 30 Tage ‚Üí Archiv. PDF enth√§lt trotzdem alles.",
      export: "Export (JSON)",
      pdf: "PDF-Nachweis",
      reset: "Reset",
      filters: { all:"Alle", open:"Offen", inprogress:"In Arbeit", done:"Erledigt", overdue:"√úberf√§llig" },
      clearDone: "Erledigte l√∂schen",
      ovTitle: "üìä √úbersicht & Nachweis",
      ovHint: "Live-√úberblick: Audits, offene/√ºberf√§llige Ma√ünahmen, Wiederholer.",
      ovAuditsTitle: "Letzte Audits",
      ovRepeatTitle: "Wiederkehrende Abweichungen",
      ovRepeatHint: "Top 8 (letzte 60 Ma√ünahmen)",
      yes:"Ja",
      no:"Nein",
      none:"Keine",
      ifDev: "Abweichung ‚Üí Ma√ünahme + Foto Pflicht",
      deviation: "Abweichung",
      measure: "Ma√ünahme",
      owner: "Verantwortlich",
      due: "Termin",
      status: "Status",
      effectiveness: "Wirksamkeit gepr√ºft",
      open:"Offen",
      inprogress:"In Arbeit",
      done:"Erledigt",
      effYes:"Ja",
      effNo:"Nein",
      delete:"L√∂schen",
      overdue:"√úberf√§llig",
      created:"Erstellt",
      auditSaved:"Audit gespeichert ‚úÖ",
      needName:"Bitte Name eintragen.",
      needAnswers:"Bitte alle Fragen beantworten.",
      needMeasure:"Bei Abweichung ist Ma√ünahme Pflicht.",
      needPhoto:"Bei Abweichung ist ein Foto Pflicht.",
      role_teamcaptain:"Teamcaptain",
      role_bereichsleiter:"Bereichsleiter",
      dailyBadge:"T√§glich",
      weeklyBadge:"W√∂chentlich",
      kpi_auditsToday:"Audits heute",
      kpi_open:"Offene Ma√ünahmen",
      kpi_overdue:"√úberf√§llig",
      kpi_done7:"Erledigt (7 Tage)",
      addPhoto:"Foto hinzuf√ºgen",
      replacePhoto:"Foto ersetzen",
      removePhoto:"Foto entfernen",
      photoRequired:"Foto fehlt (Pflicht)",
      tipPdf:"Tipp: Im Druckdialog ‚ÄûAls PDF speichern‚Äú w√§hlen.",
      af_all:"Alle",
      af_done:"Erledigt",
      archSearchPH:"Suche (z. B. Stapler, PSA ‚Ä¶)",
      archivedOn:"Archiviert"
    },
    en: {
      appTitle: "Audit App light",
      appSub: "Click, track, prove ‚Äì without chaos.",
      tabAudit: "Audit",
      tabActions: "Actions",
      tabOverview: "Overview",
      tabArchive: "Archive",
      dailyTitle: "ü¶∫ Daily Safety & Forklift Check ‚Äì Goods In",
      dailyHint: "1‚Äì2 minutes ‚Ä¢ For deviations: action + photo required.",
      weeklyTitle: "üîÑ Weekly Process Audit ‚Äì Goods In",
      weeklyHint: "3‚Äì6 minutes ‚Ä¢ For deviations: action + photo required.",
      roleLabel: "Role",
      nameLabel: "Name",
      questions: "Questions",
      autoSave: "Auto-saves in your browser.",
      submit: "Save audit",
      actionsTitle: "üõ†Ô∏è Action tracking",
      actionsHint: "Deviations automatically create actions. Photo is required for deviations.",
      archTitle: "üóÑÔ∏è Archive (read-only)",
      archHint: "Automatic: Done + 30 days ‚Üí archive. PDF still includes everything.",
      export: "Export (JSON)",
      pdf: "PDF evidence",
      reset: "Reset",
      filters: { all:"All", open:"Open", inprogress:"In progress", done:"Done", overdue:"Overdue" },
      clearDone: "Delete done",
      ovTitle: "üìä Overview & evidence",
      ovHint: "Live view: audits, open/overdue actions, repeat issues.",
      ovAuditsTitle: "Latest audits",
      ovRepeatTitle: "Repeat deviations",
      ovRepeatHint: "Top 8 (last 60 actions)",
      yes:"Yes",
      no:"No",
      none:"None",
      ifDev: "Deviation ‚Üí action + photo required",
      deviation: "Deviation",
      measure: "Action",
      owner: "Owner",
      due: "Due date",
      status: "Status",
      effectiveness: "Effectiveness checked",
      open:"Open",
      inprogress:"In progress",
      done:"Done",
      effYes:"Yes",
      effNo:"No",
      delete:"Delete",
      overdue:"Overdue",
      created:"Created",
      auditSaved:"Audit saved ‚úÖ",
      needName:"Please enter a name.",
      needAnswers:"Please answer all questions.",
      needMeasure:"For a deviation, an action is required.",
      needPhoto:"For a deviation, a photo is required.",
      role_teamcaptain:"Teamcaptain",
      role_bereichsleiter:"Area lead",
      dailyBadge:"Daily",
      weeklyBadge:"Weekly",
      kpi_auditsToday:"Audits today",
      kpi_open:"Open actions",
      kpi_overdue:"Overdue",
      kpi_done7:"Done (7 days)",
      addPhoto:"Add photo",
      replacePhoto:"Replace photo",
      removePhoto:"Remove photo",
      photoRequired:"Missing photo (required)",
      tipPdf:"Tip: In the print dialog choose ‚ÄúSave as PDF‚Äù.",
      af_all:"All",
      af_done:"Done",
      archSearchPH:"Search (e.g. forklift, PPE ‚Ä¶)",
      archivedOn:"Archived"
    }
  };

  const AUDITS = {
    daily: {
      type: "daily",
      titleKey: "dailyTitle",
      questions: [
        { id:"psa", de:"Wird PSA vollst√§ndig getragen?", en:"Is PPE worn completely?" },
        { id:"forklog", de:"Staplerpr√ºfbuch heute ausgef√ºllt?", en:"Forklift check log completed today?" },
        { id:"lanes", de:"Verkehrswege frei & markiert?", en:"Traffic lanes clear & marked?" },
        { id:"forkissues", de:"Auff√§lligkeiten an Staplern?", en:"Any issues with forklifts?" , special:"issueYesNo"}
      ]
    },
    weekly: {
      type: "weekly",
      titleKey: "weeklyTitle",
      questions: [
        { id:"hu", de:"HU bei allen Wareneing√§ngen vorhanden?", en:"HU present for all receipts?" },
        { id:"checklists", de:"Checklisten vollst√§ndig ausgef√ºllt?", en:"Checklists fully completed?" },
        { id:"samples", de:"Musterentnahmen korrekt dokumentiert?", en:"Sampling documented correctly?" },
        { id:"systemvsphys", de:"Systembuchung = physische Ware?", en:"System booking matches physical goods?" },
        { id:"putaway", de:"Einlagerung gem√§√ü Vorgabe?", en:"Put-away according to standard?" }
      ]
    }
  };

  function roleLabel(role, lang) {
    return role === "bereichsleiter" ? I18N[lang].role_bereichsleiter : I18N[lang].role_teamcaptain;
  }

  function questionText(q, lang) { return lang === "en" ? q.en : q.de; }

  function applyLanguage() {
    const lang = state.lang;
    const t = I18N[lang];

    $("appTitle").textContent = t.appTitle;
    $("appSub").textContent = t.appSub;

    $("tabAudit").textContent = t.tabAudit;
    $("tabActions").textContent = t.tabActions;
    $("tabOverview").textContent = t.tabOverview;
    $("tabArchive").textContent = t.tabArchive;

    $("dailyTitle").textContent = t.dailyTitle;
    $("dailyHint").textContent = t.dailyHint;
    $("weeklyTitle").textContent = t.weeklyTitle;
    $("weeklyHint").textContent = t.weeklyHint;

    $("dailyBadge").textContent = t.dailyBadge;
    $("weeklyBadge").textContent = t.weeklyBadge;

    $("roleLabelDaily").textContent = t.roleLabel;
    $("nameLabelDaily").textContent = t.nameLabel;
    $("roleLabelWeekly").textContent = t.roleLabel;
    $("nameLabelWeekly").textContent = t.nameLabel;

    $("questionsDaily").textContent = t.questions;
    $("questionsWeekly").textContent = t.questions;

    $("autoSaveHint").textContent = t.autoSave;
    $("autoSaveHint2").textContent = t.autoSave;

    $("submitDaily").textContent = t.submit;
    $("submitWeekly").textContent = t.submit;

    $("actionsTitle").textContent = t.actionsTitle;
    $("actionsHint").textContent = t.actionsHint;

    $("archTitle").textContent = t.archTitle;
    $("archHint").textContent = t.archHint;

    $("exportBtn").textContent = t.export;
    $("pdfBtn").textContent = t.pdf;
    $("resetBtn").textContent = t.reset;

    $("f_all").textContent = t.filters.all;
    $("f_open").textContent = t.filters.open;
    $("f_inprogress").textContent = t.filters.inprogress;
    $("f_done").textContent = t.filters.done;
    $("f_overdue").textContent = t.filters.overdue;

    $("clearDoneBtn").textContent = t.clearDone;

    $("ovTitle").textContent = t.ovTitle;
    $("ovHint").textContent = t.ovHint;
    $("ovAuditsTitle").textContent = t.ovAuditsTitle;
    $("ovRepeatTitle").textContent = t.ovRepeatTitle;
    $("ovRepeatHint").textContent = t.ovRepeatHint;

    $("af_all").textContent = t.af_all;
    $("af_done").textContent = t.af_done;
    $("archiveSearch").placeholder = t.archSearchPH;

    buildQuestions("dailyQuestions", "daily");
    buildQuestions("weeklyQuestions", "weekly");
    renderAll();
  }

  function getRadioValue(groupName) {
    const el = document.querySelector(`input[name="${groupName}"]:checked`);
    return el ? el.value : "";
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function buildQuestions(containerId, auditKey) {
    const lang = state.lang;
    const t = I18N[lang];
    const container = $(containerId);
    container.innerHTML = "";

    const draft = state.drafts[auditKey] || {};

    AUDITS[auditKey].questions.forEach((q) => {
      const qWrap = document.createElement("div");
      qWrap.className = "q";

      const title = document.createElement("div");
      title.className = "qTitle";
      title.textContent = questionText(q, lang);
      qWrap.appendChild(title);

      const yn = document.createElement("div");
      yn.className = "yn";

      const name = `${auditKey}_${q.id}`;
      const v = draft[q.id] || "";
      const yesLabel = document.createElement("label");
      yesLabel.innerHTML = `<input type="radio" name="${name}" value="yes" ${v==="yes"?"checked":""}/> ${t.yes}`;
      const noLabel = document.createElement("label");
      noLabel.innerHTML = `<input type="radio" name="${name}" value="no" ${v==="no"?"checked":""}/> ${t.no}`;
      yn.appendChild(yesLabel);
      yn.appendChild(noLabel);

      const noteBox = document.createElement("div");
      noteBox.className = "reqBox";
      const needsActionOn = q.special === "issueYesNo" ? "yes" : "no";

      const hintRow = document.createElement("div");
      hintRow.className = "reqHint";
      hintRow.innerHTML = `<div class="small"><b>${t.ifDev}</b></div>`;

      const noteArea = document.createElement("textarea");
      noteArea.placeholder = `${t.measure}`;
      noteArea.value = (draft[`${q.id}_measure`] || "");

      const ownerRow = document.createElement("div");
      ownerRow.className = "grid2";
      ownerRow.style.marginTop = "8px";

      const ownerDiv = document.createElement("div");
      ownerDiv.innerHTML = `<div class="muted">${t.owner}</div>`;
      const ownerSel = document.createElement("select");
      ownerSel.innerHTML = `
        <option value="teamcaptain">${roleLabel("teamcaptain", lang)}</option>
        <option value="bereichsleiter">${roleLabel("bereichsleiter", lang)}</option>
      `;
      ownerSel.value = draft[`${q.id}_ownerRole`] || "teamcaptain";
      ownerDiv.appendChild(ownerSel);

      const dueDiv = document.createElement("div");
      dueDiv.innerHTML = `<div class="muted">${t.due}</div>`;
      const dueInput = document.createElement("input");
      dueInput.type = "date";
      dueInput.value = draft[`${q.id}_due`] || "";
      dueDiv.appendChild(dueInput);

      ownerRow.appendChild(ownerDiv);
      ownerRow.appendChild(dueDiv);

      const photoWrap = document.createElement("div");
      photoWrap.className = "photoWrap";
      const photoRow = document.createElement("div");
      photoRow.className = "photoRow";

      const photoInfo = document.createElement("div");
      photoInfo.innerHTML = `<div class="muted">${t.deviation}</div><div class="small">${questionText(q, lang)}</div>`;

      const photoBtns = document.createElement("div");
      photoBtns.className = "row";

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.setAttribute("capture", "environment");
      fileInput.style.display = "none";

      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.textContent = draft[`${q.id}_photo`] ? t.replacePhoto : t.addPhoto;

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "secondary";
      removeBtn.textContent = t.removePhoto;

      photoBtns.appendChild(addBtn);
      photoBtns.appendChild(removeBtn);

      photoRow.appendChild(photoInfo);
      photoRow.appendChild(photoBtns);

      const photoWarn = document.createElement("div");
      photoWarn.className = "dangerText";
      photoWarn.style.marginTop = "6px";
      photoWarn.textContent = t.photoRequired;
      photoWarn.style.display = "none";

      const thumb = document.createElement("img");
      thumb.className = "photoThumb";
      if (draft[`${q.id}_photo`]) {
        thumb.src = draft[`${q.id}_photo`];
        thumb.classList.add("show");
      }

      addBtn.addEventListener("click", () => fileInput.click());
      removeBtn.addEventListener("click", () => {
        state.drafts[auditKey][`${q.id}_photo`] = "";
        thumb.src = "";
        thumb.classList.remove("show");
        addBtn.textContent = t.addPhoto;
        save();
        renderAll();
      });

      fileInput.addEventListener("change", async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const dataUrl = await readFileAsDataURL(file);
        state.drafts[auditKey][`${q.id}_photo`] = dataUrl;
        thumb.src = dataUrl;
        thumb.classList.add("show");
        addBtn.textContent = t.replacePhoto;
        photoWarn.style.display = "none";
        save();
        renderAll();
      });

      photoWrap.appendChild(photoRow);
      photoWrap.appendChild(fileInput);
      photoWrap.appendChild(photoWarn);
      photoWrap.appendChild(thumb);

      noteBox.appendChild(hintRow);
      noteBox.appendChild(noteArea);
      noteBox.appendChild(ownerRow);
      noteBox.appendChild(photoWrap);

      qWrap.appendChild(yn);
      qWrap.appendChild(noteBox);

      function updateReqBox() {
        const val = getRadioValue(name);
        const show = val === needsActionOn;
        noteBox.classList.toggle("show", show);

        state.drafts[auditKey][q.id] = val || "";
        state.drafts[auditKey][`${q.id}_measure`] = noteArea.value || "";
        state.drafts[auditKey][`${q.id}_ownerRole`] = ownerSel.value || "teamcaptain";
        state.drafts[auditKey][`${q.id}_due`] = dueInput.value || "";
        save();

        const photoDataUrl = state.drafts[auditKey][`${q.id}_photo`] || "";
        photoWarn.style.display = (show && !photoDataUrl) ? "block" : "none";
      }

      qWrap.addEventListener("change", (e) => {
        if (e.target && (e.target.name === name || e.target === ownerSel || e.target === dueInput)) {
          updateReqBox();
          renderAll();
        }
      });
      noteArea.addEventListener("input", () => updateReqBox());

      const initialVal = getRadioValue(name);
      noteBox.classList.toggle("show", initialVal === needsActionOn);
      const photoDataUrlInit = state.drafts[auditKey][`${q.id}_photo`] || "";
      photoWarn.style.display = (initialVal === needsActionOn && !photoDataUrlInit) ? "block" : "none";

      container.appendChild(qWrap);
    });
  }

  function createOrUpdateActionFromResult(audit, q, r) {
    const needsActionOn = q.special === "issueYesNo" ? "yes" : "no";
    const needsAction = r.answer === needsActionOn;
    if (!needsAction) return;

    const existing = state.actions.find(a => a.auditId === audit.id && a.qid === q.id);
    const dueAt = r.due ? new Date(r.due + "T00:00:00").getTime() : (ts() + 24*60*60*1000);

    if (existing) {
      if (!existing.measure && r.measure) existing.measure = r.measure;
      if (!existing.ownerRole) existing.ownerRole = r.ownerRole;
      if (!existing.dueAt) existing.dueAt = dueAt;
      if (!existing.photoDataUrl && r.photoDataUrl) existing.photoDataUrl = r.photoDataUrl;
      save();
      return;
    }

    state.actions.unshift({
      id: uid(),
      auditId: audit.id,
      auditType: audit.type,
      auditTitle: audit.title,
      qid: q.id,
      question: r.question,
      deviation: r.question,
      measure: r.measure || "",
      ownerRole: r.ownerRole || "teamcaptain",
      ownerName: "",
      dueAt,
      status: "open",
      effectiveness: "no",
      photoDataUrl: r.photoDataUrl || "",
      createdAt: ts(),
      doneAt: null,
      archivedAt: null
    });
    save();
  }

  function submitAudit(auditKey) {
    const lang = state.lang;
    const t = I18N[lang];
    const roleSel = auditKey === "daily" ? $("roleDaily") : $("roleWeekly");
    const nameIn  = auditKey === "daily" ? $("nameDaily") : $("nameWeekly");

    const role = roleSel.value;
    const name = (nameIn.value || "").trim();
    if (!name) { alert(t.needName); return; }

    const draft = state.drafts[auditKey] || {};
    const results = [];

    for (const q of AUDITS[auditKey].questions) {
      const group = `${auditKey}_${q.id}`;
      const ans = getRadioValue(group);
      if (!ans) { alert(t.needAnswers); return; }

      const needsActionOn = q.special === "issueYesNo" ? "yes" : "no";
      const isDeviation = ans === needsActionOn;

      const measure = (draft[`${q.id}_measure`] || "").trim();
      const ownerRole = draft[`${q.id}_ownerRole`] || "teamcaptain";
      const due = draft[`${q.id}_due`] || "";
      const photoDataUrl = draft[`${q.id}_photo`] || "";

      if (isDeviation && !measure) { alert(t.needMeasure); return; }
      if (isDeviation && !photoDataUrl) { alert(t.needPhoto); return; }

      results.push({ qid: q.id, question: questionText(q, lang), answer: ans, measure, ownerRole, due, photoDataUrl });
    }

    const audit = {
      id: uid(),
      type: AUDITS[auditKey].type,
      title: I18N[lang][AUDITS[auditKey].titleKey],
      role,
      name,
      createdAt: ts(),
      results
    };

    state.audits.unshift(audit);

    for (const q of AUDITS[auditKey].questions) {
      const r = results.find(x => x.qid === q.id);
      createOrUpdateActionFromResult(audit, q, r);
    }

    state.drafts[auditKey] = {};
    save();

    if (auditKey === "daily") {
      $("nameDaily").value = "";
      buildQuestions("dailyQuestions","daily");
    } else {
      $("nameWeekly").value = "";
      buildQuestions("weeklyQuestions","weekly");
    }

    autoArchiveDoneActions();
    renderAll();
    alert(t.auditSaved);
  }

  function isOverdue(a) {
    if (a.status === "done") return false;
    const today = startOfToday();
    return (a.dueAt || 0) < today;
  }

  function filterActions(list) {
    const f = $("actionsFilter").value;
    if (f === "open") return list.filter(a => a.status === "open");
    if (f === "inprogress") return list.filter(a => a.status === "inprogress");
    if (f === "done") return list.filter(a => a.status === "done");
    if (f === "overdue") return list.filter(a => isOverdue(a));
    return list;
  }

  function renderActions() {
    const lang = state.lang;
    const t = I18N[lang];
    const list = $("actionsList");
    list.innerHTML = "";

    autoArchiveDoneActions();

    const filtered = filterActions(state.actions);

    if (filtered.length === 0) {
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="itemTop"><div><b>${t.none}</b></div></div><div class="small">${t.actionsHint}</div>`;
      list.appendChild(empty);
      return;
    }

    filtered.forEach((a) => {
      const item = document.createElement("div");
      item.className = "item";

      const overdue = isOverdue(a);
      const badge = overdue
        ? `<span class="badge danger">${t.overdue}</span>`
        : `<span class="badge">${t.created}: ${fmtDateTime(a.createdAt, lang)}</span>`;

      const title = document.createElement("div");
      title.className = "itemTop";
      title.innerHTML = `
        <div>
          <div><b>${a.auditTitle}</b> <span class="small">‚Ä¢ ${a.question}</span></div>
          <div class="small">${t.owner}: ${roleLabel(a.ownerRole, lang)} ${a.ownerName ? "‚Ä¢ " + a.ownerName : ""} ‚Ä¢ ${t.due}: ${a.dueAt ? new Date(a.dueAt).toISOString().slice(0,10) : "-"}</div>
        </div>
        ${badge}
      `;

      const fields = document.createElement("div");
      fields.className = "grid2";

      const left = document.createElement("div");
      left.innerHTML = `<div class="muted">${t.deviation}</div><div>${a.deviation}</div>`;

      const right = document.createElement("div");
      const meaLab = document.createElement("div");
      meaLab.className = "muted";
      meaLab.textContent = t.measure;
      const meaArea = document.createElement("textarea");
      meaArea.value = a.measure || "";
      right.appendChild(meaLab);
      right.appendChild(meaArea);

      if (a.photoDataUrl) {
        const img = document.createElement("img");
        img.src = a.photoDataUrl;
        img.className = "photoMini";
        right.appendChild(img);
      } else {
        const warn = document.createElement("div");
        warn.className = "dangerText";
        warn.textContent = t.photoRequired;
        right.appendChild(warn);
      }

      fields.appendChild(left);
      fields.appendChild(right);

      const controls = document.createElement("div");
      controls.className = "grid2";

      const c1 = document.createElement("div");
      c1.innerHTML = `<div class="muted">${t.owner}</div>`;
      const ownerSel = document.createElement("select");
      ownerSel.innerHTML = `
        <option value="teamcaptain">${roleLabel("teamcaptain", lang)}</option>
        <option value="bereichsleiter">${roleLabel("bereichsleiter", lang)}</option>
      `;
      ownerSel.value = a.ownerRole || "teamcaptain";
      const ownerName = document.createElement("input");
      ownerName.placeholder = t.nameLabel;
      ownerName.value = a.ownerName || "";
      c1.appendChild(ownerSel);
      c1.appendChild(ownerName);

      const c2 = document.createElement("div");
      c2.innerHTML = `<div class="muted">${t.due}</div>`;
      const dueIn = document.createElement("input");
      dueIn.type = "date";
      dueIn.value = a.dueAt ? new Date(a.dueAt).toISOString().slice(0,10) : "";

      const statusLab = document.createElement("div");
      statusLab.className = "muted";
      statusLab.style.marginTop = "8px";
      statusLab.textContent = t.status;

      const statusSel = document.createElement("select");
      statusSel.innerHTML = `
        <option value="open">${t.open}</option>
        <option value="inprogress">${t.inprogress}</option>
        <option value="done">${t.done}</option>
      `;
      statusSel.value = a.status || "open";

      const effLab = document.createElement("div");
      effLab.className = "muted";
      effLab.style.marginTop = "8px";
      effLab.textContent = t.effectiveness;

      const effSel = document.createElement("select");
      effSel.innerHTML = `
        <option value="no">${t.effNo}</option>
        <option value="yes">${t.effYes}</option>
      `;
      effSel.value = a.effectiveness || "no";

      c2.appendChild(dueIn);
      c2.appendChild(statusLab);
      c2.appendChild(statusSel);
      c2.appendChild(effLab);
      c2.appendChild(effSel);

      controls.appendChild(c1);
      controls.appendChild(c2);

      const buttons = document.createElement("div");
      buttons.className = "row";
      buttons.style.justifyContent = "flex-end";

      const delBtn = document.createElement("button");
      delBtn.className = "secondary";
      delBtn.textContent = t.delete;
      buttons.appendChild(delBtn);

      meaArea.addEventListener("input", () => { a.measure = meaArea.value; save(); renderAll(); });
      ownerSel.addEventListener("change", () => { a.ownerRole = ownerSel.value; save(); renderAll(); });
      ownerName.addEventListener("input", () => { a.ownerName = ownerName.value; save(); renderAll(); });
      dueIn.addEventListener("change", () => {
        a.dueAt = dueIn.value ? new Date(dueIn.value + "T00:00:00").getTime() : null;
        save(); renderAll();
      });

      statusSel.addEventListener("change", () => {
        const newStatus = statusSel.value;
        a.status = newStatus;

        if (newStatus === "done" && !a.doneAt) a.doneAt = Date.now();
        if (newStatus !== "done") a.doneAt = null;

        save();
        autoArchiveDoneActions();
        renderAll();
      });

      effSel.addEventListener("change", () => { a.effectiveness = effSel.value; save(); renderAll(); });

      delBtn.addEventListener("click", () => {
        state.actions = state.actions.filter(x => x.id !== a.id);
        save(); renderAll();
      });

      item.appendChild(title);
      item.appendChild(fields);
      item.appendChild(controls);
      item.appendChild(buttons);
      list.appendChild(item);
    });
  }

  function renderArchive() {
    const lang = state.lang;
    const t = I18N[lang];

    const list = $("archiveList");
    list.innerHTML = "";

    autoArchiveDoneActions(); // sicherstellen, dass Archiv aktuell ist

    const f = $("archiveFilter").value;
    const q = ($("archiveSearch").value || "").trim().toLowerCase();

    let items = [...(state.archivedActions || [])];

    if (f === "done") items = items.filter(a => a.status === "done");

    if (q) {
      items = items.filter(a => {
        const blob = [
          a.auditTitle, a.question, a.deviation, a.measure,
          a.ownerName, a.ownerRole
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if (items.length === 0) {
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="itemTop"><div><b>${t.none}</b></div></div><div class="small">${t.archHint}</div>`;
      list.appendChild(empty);
      return;
    }

    items.forEach(a => {
      const item = document.createElement("div");
      item.className = "item";

      const archivedAt = a.archivedAt ? fmtDateTime(a.archivedAt, lang) : "";

      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div><b>${a.auditTitle}</b> <span class="small">‚Ä¢ ${a.question}</span></div>
            <div class="small">
              ${t.owner}: ${roleLabel(a.ownerRole, lang)} ${a.ownerName ? "‚Ä¢ " + a.ownerName : ""} ‚Ä¢
              ${t.due}: ${a.dueAt ? new Date(a.dueAt).toISOString().slice(0,10) : "-"} ‚Ä¢
              ${t.status}: ${t[a.status] || a.status}
            </div>
            ${archivedAt ? `<div class="small">${t.archivedOn}: ${archivedAt}</div>` : ``}
          </div>
          <span class="badge">${t.tabArchive}</span>
        </div>

        <div class="grid2">
          <div class="readonlyBox">
            <div class="muted">${t.deviation}</div>
            <div>${a.deviation || ""}</div>
          </div>
          <div class="readonlyBox">
            <div class="muted">${t.measure}</div>
            <div>${(a.measure || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
            ${a.photoDataUrl ? `<img class="photoMini" src="${a.photoDataUrl}" />` : `<div class="dangerText">${t.photoRequired}</div>`}
            <div class="small" style="margin-top:8px;">
              <b>${t.effectiveness}:</b> ${a.effectiveness === "yes" ? t.effYes : t.effNo}
            </div>
          </div>
        </div>
      `;

      list.appendChild(item);
    });
  }

  function renderOverview() {
    const lang = state.lang;
    const t = I18N[lang];
    const kpi = $("kpi");
    kpi.innerHTML = "";

    const today = startOfToday();
    const weekAgo = today - 6*24*60*60*1000;

    const auditsToday = state.audits.filter(a => a.createdAt >= today).length;
    const openActions = state.actions.filter(a => a.status !== "done").length;
    const overdueActions = state.actions.filter(a => isOverdue(a)).length;
    const done7 = [...state.actions, ...state.archivedActions].filter(a => a.status === "done" && a.createdAt >= weekAgo).length;

    const makePill = (label, value) => {
      const s = document.createElement("span");
      s.className = "pill";
      s.textContent = `${label}: ${value}`;
      return s;
    };

    kpi.appendChild(makePill(t.kpi_auditsToday, auditsToday));
    kpi.appendChild(makePill(t.kpi_open, openActions));
    kpi.appendChild(makePill(t.kpi_overdue, overdueActions));
    kpi.appendChild(makePill(t.kpi_done7, done7));

    const auditsList = $("auditsList");
    auditsList.innerHTML = "";
    const latest = state.audits.slice(0, 8);

    if (latest.length === 0) {
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div><b>${t.none}</b></div><div class="small">${t.tabAudit}: ${t.none}</div>`;
      auditsList.appendChild(empty);
    } else {
      latest.forEach((a) => {
        const item = document.createElement("div");
        item.className = "item";
        const deviations = a.results.filter(r => {
          const q = AUDITS[a.type].questions.find(x => x.id === r.qid);
          const needsActionOn = q && q.special === "issueYesNo" ? "yes" : "no";
          return r.answer === needsActionOn;
        }).length;

        item.innerHTML = `
          <div class="itemTop">
            <div>
              <div><b>${a.title}</b></div>
              <div class="small">${roleLabel(a.role, lang)} ‚Ä¢ ${a.name} ‚Ä¢ ${fmtDateTime(a.createdAt, lang)}</div>
            </div>
            <span class="badge ${deviations>0 ? "danger" : "ok"}">${deviations>0 ? (t.deviation + ": " + deviations) : "OK"}</span>
          </div>
        `;
        auditsList.appendChild(item);
      });
    }

    const repeatList = $("repeatList");
    repeatList.innerHTML = "";
    const sample = [...state.actions, ...state.archivedActions].slice(0, MAX_REPEAT_SAMPLE);

    const count = new Map();
    sample.forEach(a => {
      const key = a.deviation || a.question || "";
      if (!key) return;
      count.set(key, (count.get(key) || 0) + 1);
    });

    const top = [...count.entries()].sort((a,b) => b[1]-a[1]).slice(0, 8);
    if (top.length === 0) {
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div><b>${t.none}</b></div><div class="small">${t.deviation}: ${t.none}</div>`;
      repeatList.appendChild(empty);
    } else {
      top.forEach(([k,v]) => {
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div class="itemTop">
            <div><b>${k}</b></div>
            <span class="badge">${v}√ó</span>
          </div>
        `;
        repeatList.appendChild(item);
      });
    }
  }

  function setTab(tab) {
    document.querySelectorAll(".tabbtn").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
    $("view_audit").style.display = tab === "audit" ? "block" : "none";
    $("view_actions").style.display = tab === "actions" ? "block" : "none";
    $("view_overview").style.display = tab === "overview" ? "block" : "none";
    $("view_archive").style.display = tab === "archive" ? "block" : "none";
    renderAll();
  }

  function exportJSON() {
    const data = {
      exportedAt: new Date().toISOString(),
      version: "v4",
      audits: state.audits,
      actions: state.actions,
      archivedActions: state.archivedActions
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `audit-app-light_export_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function resetAll() {
    if (!confirm("Alles l√∂schen? / Delete everything?")) return;
    const keepLang = state.lang;
    localStorage.removeItem(STORAGE_KEY);
    state = load();
    state.lang = keepLang;
    state.audits = [];
    state.actions = [];
    state.archivedActions = [];
    state.drafts = { daily:{}, weekly:{} };
    save();
    applyLanguage();
  }

  function clearDone() {
    // l√∂scht nur erledigte im AKTIVEN Bereich (Archiv bleibt als Nachweis bestehen)
    state.actions = state.actions.filter(a => a.status !== "done");
    save();
    renderAll();
  }

  function renderNowPill() {
    const lang = state.lang;
    const loc = lang === "en" ? "en-GB" : "de-DE";
    $("nowPill").textContent = new Date().toLocaleString(loc, { dateStyle:"medium", timeStyle:"short" });
  }

  function renderAll() {
    autoArchiveDoneActions();
    renderNowPill();
    renderActions();
    renderOverview();
    renderArchive();
    $("clearDoneBtn").disabled = state.actions.every(a => a.status !== "done");
  }

  // --- PDF report (print to PDF) ---
  function escapeHtml(s) {
    return (s||"").replace(/[&<>"']/g, (c) => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c]));
  }

  function makeReportHTML() {
    const lang = state.lang;
    const t = I18N[lang];

    const audits = state.audits.slice(0, 20);
    const actions = [...state.actions, ...(state.archivedActions || [])]; // ALLE Ma√ünahmen

    const header = `
      <h1>${escapeHtml(t.appTitle)} ‚Äì ${escapeHtml(t.pdf)}</h1>
      <div class="meta">${escapeHtml(fmtDateTime(Date.now(), lang))}</div>
      <div class="hint">${escapeHtml(t.tipPdf)}</div>
      <hr/>
    `;

    const actionsByAudit = new Map();
    actions.forEach(a => {
      if (!actionsByAudit.has(a.auditId)) actionsByAudit.set(a.auditId, []);
      actionsByAudit.get(a.auditId).push(a);
    });

    const auditBlocks = audits.map(a => {
      const aActions = actionsByAudit.get(a.id) || [];

      const rows = a.results.map(r => {
        const answer = r.answer === "yes" ? t.yes : t.no;
        const isDev = (a.type === "daily" && r.qid === "forkissues") ? (r.answer === "yes") : (r.answer === "no");
        return `
          <tr>
            <td>${escapeHtml(r.question)}</td>
            <td class="${isDev ? "dev" : "ok"}">${escapeHtml(answer)}</td>
            <td>${isDev ? escapeHtml(r.measure || "") : ""}</td>
          </tr>
        `;
      }).join("");

      const actionRows = aActions.map(ac => `
        <div class="action">
          <div><b>${escapeHtml(t.deviation)}:</b> ${escapeHtml(ac.deviation || "")}</div>
          <div><b>${escapeHtml(t.measure)}:</b> ${escapeHtml(ac.measure || "")}</div>
          <div><b>${escapeHtml(t.owner)}:</b> ${escapeHtml(roleLabel(ac.ownerRole, lang))} ${ac.ownerName ? "‚Ä¢ " + escapeHtml(ac.ownerName) : ""}</div>
          <div><b>${escapeHtml(t.due)}:</b> ${ac.dueAt ? escapeHtml(new Date(ac.dueAt).toISOString().slice(0,10)) : "-"}</div>
          <div><b>${escapeHtml(t.status)}:</b> ${escapeHtml(t[ac.status] || ac.status)} ‚Ä¢ <b>${escapeHtml(t.effectiveness)}:</b> ${escapeHtml(ac.effectiveness === "yes" ? t.effYes : t.effNo)}</div>
          ${ac.photoDataUrl ? `<img class="photo" src="${ac.photoDataUrl}" />` : `<div class="warn">${escapeHtml(t.photoRequired)}</div>`}
        </div>
      `).join("");

      return `
        <section class="audit">
          <h2>${escapeHtml(a.title)}</h2>
          <div class="meta">${escapeHtml(roleLabel(a.role, lang))} ‚Ä¢ ${escapeHtml(a.name)} ‚Ä¢ ${escapeHtml(fmtDateTime(a.createdAt, lang))}</div>
          <table>
            <thead>
              <tr>
                <th>${escapeHtml(t.questions)}</th>
                <th>${escapeHtml(t.status)}</th>
                <th>${escapeHtml(t.measure)}</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <h3>${escapeHtml(t.actionsTitle)}</h3>
          ${aActions.length ? actionRows : `<div class="meta">${escapeHtml(t.none)}</div>`}
        </section>
      `;
    }).join("");

    return `
      <!doctype html>
      <html>
      <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>${escapeHtml(t.appTitle)} ‚Äì ${escapeHtml(t.pdf)}</title>
        <style>
          :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
          body { margin: 24px; color: #111; }
          h1 { margin: 0 0 6px; font-size: 20px; }
          .meta { color:#555; font-size: 12px; margin-bottom: 8px; }
          .hint { color:#555; font-size: 12px; margin-bottom: 14px; }
          hr { border: none; border-top: 1px solid #ddd; margin: 14px 0; }
          section.audit { break-inside: avoid; margin-bottom: 18px; }
          h2 { margin: 0 0 4px; font-size: 16px; }
          h3 { margin: 10px 0 6px; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; font-size: 12px; }
          th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
          th { background: #f5f5f5; text-align: left; }
          td.ok { background: #f0fff3; }
          td.dev { background: #fff0f0; }
          .action { border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 8px 0; }
          .photo { max-width: 240px; width: 100%; border: 1px solid #ddd; border-radius: 10px; margin-top: 8px; }
          .warn { color: #b00020; font-size: 12px; margin-top: 6px; }
          @media print { body { margin: 10mm; } }
        </style>
      </head>
      <body>
        ${header}
        ${auditBlocks || `<div class="meta">${escapeHtml(I18N[lang].none)}</div>`}
      </body>
      </html>
    `;
  }

  function openPdfReport() {
    const html = makeReportHTML();
    const w = window.open("", "_blank");
    if (!w) {
      alert("Popup blockiert. Bitte Popups erlauben und nochmal klicken.");
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();
    setTimeout(() => w.print(), 400);
  }

  function init() {
    $("lang").value = state.lang;

    buildQuestions("dailyQuestions", "daily");
    buildQuestions("weeklyQuestions", "weekly");

    document.querySelectorAll(".tabbtn").forEach(btn => btn.addEventListener("click", () => setTab(btn.dataset.tab)));

    $("lang").addEventListener("change", () => { state.lang = $("lang").value; save(); applyLanguage(); });

    $("submitDaily").addEventListener("click", () => submitAudit("daily"));
    $("submitWeekly").addEventListener("click", () => submitAudit("weekly"));

    $("actionsFilter").addEventListener("change", renderAll);
    $("clearDoneBtn").addEventListener("click", clearDone);

    $("archiveFilter").addEventListener("change", renderAll);
    $("archiveSearch").addEventListener("input", renderAll);

    $("pdfBtn").addEventListener("click", openPdfReport);
    $("exportBtn").addEventListener("click", exportJSON);
    $("resetBtn").addEventListener("click", resetAll);

    autoArchiveDoneActions();
    setInterval(autoArchiveDoneActions, 6 * 60 * 60 * 1000);
    setInterval(renderNowPill, 15000);

    applyLanguage();
  }

  // When archiving, stamp archivedAt (so users see when it moved)
  const _autoArchiveOriginal = autoArchiveDoneActions;
  autoArchiveDoneActions = function() {
    const before = state.actions.map(a => a.id);
    _autoArchiveOriginal();
    // Stamp archivedAt for newly moved items (best-effort)
    const afterActive = new Set(state.actions.map(a => a.id));
    for (const a of state.archivedActions) {
      if (!a.archivedAt) a.archivedAt = Date.now();
      // If an item somehow returned to active, ignore
      if (afterActive.has(a.id)) a.archivedAt = null;
    }
    save();
  };

  init();
})();
</script>
</body>
</html>
